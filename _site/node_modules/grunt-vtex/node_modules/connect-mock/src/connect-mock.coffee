path = require 'path'
fs = require 'fs'

module.exports = (options = {}) ->
	(req, res, next) ->
		requestPath = req.url.split('?')[0]
		mockFilePath = path.join((options.mockDirectory or 'mock/'), requestPath)
		mockFilePath = mockFilePath.replace /\/$/, ''
		try
			data = ''
			stat = fs.lstatSync mockFilePath
			# Either a directory or file exists in the matching path
			if stat.isDirectory()
				fileName = mockFilePath.slice mockFilePath.lastIndexOf '/'
				# Append the folder name to the path to find the corresponding file
				mockFilePath = path.join mockFilePath, fileName
				data = fs.readFileSync mockFilePath, 'utf8'
			else
				data = fs.readFileSync mockFilePath, 'utf8'

			console.log '[connect-mock] end', mockFilePath if options.verbose
			res.end data
		catch e
			console.log '[connect-mock]', e if options.verbose
			next()